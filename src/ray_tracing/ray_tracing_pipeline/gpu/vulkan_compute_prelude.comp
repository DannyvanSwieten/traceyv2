#version 460

layout (local_size_x = 32, local_size_y = 32, local_size_z = 1) in;

struct BvhNode{
    float minx, miny, minz;
    uint firstChildOrPrim; // For inner nodes: left child index. For leaf nodes: first triangle index.
    float maxx, maxy, maxz;
    uint primCountAndType; // For inner nodes: right child index. For leaf nodes: number of triangles.
};

struct Ray{
    vec3 origin;
    vec3 direction;
    vec3 invDirection;
};

struct Instance{
    vec4 row0;
    vec4 row1;
    vec4 row2;
    uint customIndexAndMask;
    uint sbtOffsetAndFlags;
    uint blasAddress;
    uint padding;
};

struct BlasInfo{
    uint rootNodeIndex;
    uint triangleCount;
    uint triangleOffset;
    uint padding;
};

struct HitInfo{
    float t;
    uint triangleIndex;
    uint instanceIndex;
    float barycentricU;
    float barycentricV;
};

struct BuiltIn {
    uvec3 launchID;
    uvec3 launchSize;
    vec3 rayOrigin;
    float rayTmin;
    float hitT;
    vec3 rayDirection;
    float rayTmax;
    uint instanceID;
    uint primitiveID;
    uint instanceCustomIndex;
    mat4x3 worldToObject;
    mat4x3 objectToWorld;
    vec3 hitNormal;
};

struct TriangleInfo{
    float v0x, v0y, v0z;
    float e0x, e0y, e0z;
    float e1x, e1y, e1z;
    float nx, ny, nz;
};

struct InverseTransforms{
    mat4x4 objToWorld;
    mat4x4 worldToObj;
};

BuiltIn builtIn;
#define gl_LaunchIDEXT builtIn.launchID
#define gl_LaunchSizeEXT builtIn.launchSize
#define gl_RayOriginEXT builtIn.rayOrigin
#define gl_RayTminEXT builtIn.rayTmin
#define gl_RayDirectionEXT builtIn.rayDirection
#define gl_RayTmaxEXT builtIn.rayTmax
#define gl_InstanceIDEXT builtIn.instanceID
#define gl_PrimitiveID builtIn.primitiveID
#define gl_InstanceCustomIndexEXT builtIn.instanceCustomIndex
#define gl_WorldToObjectEXT builtIn.worldToObject
#define gl_ObjectToWorldEXT builtIn.objectToWorld
#define gl_HitNormalEXT builtIn.hitNormal
#define gl_HitTEXT builtIn.hitT
#define gl_RayFlagsEXT 0u

layout(std430, set = 0, binding = 0) readonly buffer TLASInstances {
    uint instanceCount;
    uint padding[3];
    Instance instances[];
} tlasInstances;

layout(std430, set = 0, binding = 1) readonly buffer BvhNodes {
    BvhNode nodes[];
} blasNodes;

layout(std430, set = 0, binding = 2) readonly buffer BlasInfos {
    BlasInfo blases[];
} blasInfos;

layout(std430, set = 0, binding = 3) readonly buffer Triangles {
    TriangleInfo triangles[];
} blasTriangles;

layout(std430, set = 0, binding = 4) readonly buffer PrimitiveIndices {
    uint primitiveIndices[];
} blasPrimitiveIndices;

layout(std430, set = 0, binding = 5) readonly buffer TLASInstanceTransforms {
    InverseTransforms inv[];
} tlasInstanceTransforms;

// [USER_SHADER_BINDINGS]